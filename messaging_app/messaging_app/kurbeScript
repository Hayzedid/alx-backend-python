#!/bin/bash

# Kubernetes Setup Script - kurbeScript
# This script starts a Kubernetes cluster and verifies its status

echo "ğŸš€ Starting Kubernetes Cluster Setup..."
echo "========================================"

# Function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Check if minikube is installed
echo "ğŸ“‹ Checking prerequisites..."
if ! command_exists minikube; then
    echo "âŒ Minikube is not installed. Please install minikube first."
    echo "Visit: https://minikube.sigs.k8s.io/docs/start/"
    exit 1
fi

if ! command_exists kubectl; then
    echo "âŒ kubectl is not installed. Please install kubectl first."
    echo "Visit: https://kubernetes.io/docs/tasks/tools/"
    exit 1
fi

echo "âœ… Minikube and kubectl are installed"

# Start minikube cluster
echo ""
echo "ğŸ”„ Starting Minikube cluster..."
minikube start --driver=docker --cpus=2 --memory=4096

if [ $? -eq 0 ]; then
    echo "âœ… Minikube cluster started successfully"
else
    echo "âŒ Failed to start Minikube cluster"
    exit 1
fi

# Wait for cluster to be ready
echo ""
echo "â³ Waiting for cluster to be ready..."
sleep 10

# Verify cluster is running using kubectl cluster-info
echo ""
echo "ğŸ” Verifying cluster status..."
echo "Cluster Information:"
echo "==================="
kubectl cluster-info

if [ $? -eq 0 ]; then
    echo ""
    echo "âœ… Cluster is running and accessible"
else
    echo "âŒ Failed to get cluster information"
    exit 1
fi

# Retrieve available pods
echo ""
echo "ğŸ“¦ Retrieving available pods..."
echo "Current Pods in all namespaces:"
echo "==============================="
kubectl get pods --all-namespaces

# Get nodes information
echo ""
echo "ğŸ–¥ï¸  Cluster Nodes:"
echo "=================="
kubectl get nodes

# Get cluster status
echo ""
echo "ğŸ“Š Cluster Status:"
echo "=================="
kubectl get componentstatuses

# Display minikube status
echo ""
echo "ğŸ¯ Minikube Status:"
echo "=================="
minikube status

# Display useful information
echo ""
echo "ğŸ‰ Kubernetes cluster setup completed successfully!"
echo ""
echo "ğŸ“‹ Useful Commands:"
echo "==================="
echo "â€¢ View cluster info: kubectl cluster-info"
echo "â€¢ Get all pods: kubectl get pods --all-namespaces"
echo "â€¢ Get nodes: kubectl get nodes"
echo "â€¢ Minikube dashboard: minikube dashboard"
echo "â€¢ Stop cluster: minikube stop"
echo "â€¢ Delete cluster: minikube delete"
echo ""
echo "ğŸ”— Access cluster dashboard:"
echo "minikube dashboard --url"
echo ""
echo "âœ… Cluster is ready for deployments!"
